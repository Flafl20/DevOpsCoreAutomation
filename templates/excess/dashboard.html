{{define "content"}}
<div x-data="dashboardPage()" x-init="init()">
  <h1 class="text-2xl font-bold mb-6">Dashboard</h1>

  <!-- Tab headers -->
  <div class="flex border-b border-gray-200 dark:border-gray-700 mb-6">
    <button
      @click="tab = 'health'"
      :class="tab === 'health' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'"
      class="px-5 py-3 text-sm font-medium border-b-2 -mb-px transition-colors"
    >
      Health
    </button>
    <button
      @click="tab = 'powers'; $nextTick(() => renderPowerChart())"
      :class="tab === 'powers' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'"
      class="px-5 py-3 text-sm font-medium border-b-2 -mb-px transition-colors"
    >
      Powers
    </button>
    <button
      @click="tab = 'ports'"
      :class="tab === 'ports' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'"
      class="px-5 py-3 text-sm font-medium border-b-2 -mb-px transition-colors"
    >
      Port Protection
    </button>
  </div>

  <!-- Loading -->
  <template x-if="loading">
    <div class="flex items-center justify-center py-20">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
      <span class="ml-3 text-gray-500">Loading data...</span>
    </div>
  </template>

  <!-- ==================== HEALTH TAB ==================== -->
  <div x-show="tab === 'health' && !loading" x-cloak>
    <template x-if="healthData.length === 0 && !loading">
      <p class="text-gray-500 text-center py-10">No health data available yet.</p>
    </template>

    <template x-if="healthData.length > 0">
      <div>
        <!-- OLT navigation -->
        <div class="flex items-center justify-between mb-6">
          <button @click="healthIdx = (healthIdx - 1 + healthData.length) % healthData.length"
            class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"/></svg>
            Previous
          </button>
          <div class="text-center">
            <p class="text-sm font-semibold" x-text="currentHealth.device"></p>
            <p class="text-xs text-gray-500" x-text="currentHealth.host + ' \u00B7 ' + currentHealth.site"></p>
            <p class="text-xs text-gray-400 mt-0.5" x-text="(healthIdx + 1) + ' of ' + healthData.length + ' OLTs'"></p>
          </div>
          <button @click="healthIdx = (healthIdx + 1) % healthData.length"
            class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors text-sm">
            Next
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"/></svg>
          </button>
        </div>

        <!-- OLT selector pills -->
        <div class="flex flex-wrap gap-2 mb-6">
          <template x-for="(h, i) in healthData" :key="h.host">
            <button @click="healthIdx = i"
              :class="healthIdx === i ? 'bg-blue-600 text-white border-blue-600' : 'bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-700 hover:border-blue-400'"
              class="px-3 py-1.5 text-xs font-medium rounded-full border transition-colors"
              x-text="h.device">
            </button>
          </template>
        </div>

        <!-- Health card for current OLT -->
        <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-6">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h3 class="text-lg font-semibold" x-text="currentHealth.device"></h3>
              <p class="text-sm text-gray-500" x-text="currentHealth.host + ' \u00B7 ' + currentHealth.site"></p>
            </div>
            <span class="text-xs px-3 py-1.5 rounded-full bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 font-medium">Online</span>
          </div>

          <!-- Uptime -->
          <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
            <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Uptime</span>
            <p class="text-lg font-mono mt-1" x-text="currentHealth.uptime || 'N/A'"></p>
          </div>

          <!-- CPU Loads -->
          <div class="mb-6">
            <h4 class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-3">CPU Load</h4>
            <div class="space-y-3">
              <template x-for="(cpu, i) in (currentHealth.cpu_loads || [])" :key="i">
                <div>
                  <div class="flex justify-between text-xs mb-1">
                    <span class="font-medium" x-text="cpu.slot"></span>
                    <span class="font-mono" x-text="cpu.average_pct + '%'"></span>
                  </div>
                  <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full rounded-full transition-all duration-500"
                      :class="getCpuColor(cpu.average_pct)"
                      :style="'width:' + Math.min(100, cpu.average_pct) + '%'"></div>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- Temperatures - Thermometer style -->
          <div>
            <h4 class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-4">Temperature</h4>
            <div class="flex flex-wrap gap-6">
              <template x-for="(t, i) in (currentHealth.temperatures || [])" :key="i">
                <div class="flex flex-col items-center">
                  <!-- Thermometer -->
                  <div class="relative w-10 flex flex-col items-center">
                    <!-- Temperature value on top -->
                    <span class="text-sm font-bold mb-2"
                      :class="t.act_temp > 65 ? 'text-red-600 dark:text-red-400' : t.act_temp > 50 ? 'text-orange-500' : 'text-green-600 dark:text-green-400'"
                      x-text="t.act_temp + '\u00B0'"></span>
                    <!-- Thermometer body -->
                    <div class="relative w-5 h-28 rounded-full bg-gray-200 dark:bg-gray-700 overflow-hidden border-2"
                      :class="t.act_temp > 65 ? 'border-red-400' : t.act_temp > 50 ? 'border-orange-400' : 'border-green-400'">
                      <!-- Scale marks -->
                      <div class="absolute inset-x-0 top-[14%] border-t border-gray-300 dark:border-gray-600 opacity-40"></div>
                      <div class="absolute inset-x-0 top-[43%] border-t border-gray-300 dark:border-gray-600 opacity-40"></div>
                      <div class="absolute inset-x-0 top-[71%] border-t border-gray-300 dark:border-gray-600 opacity-40"></div>
                      <!-- Mercury fill (from bottom) -->
                      <div class="absolute bottom-0 inset-x-0 rounded-b-full transition-all duration-700"
                        :class="t.act_temp > 65 ? 'bg-gradient-to-t from-red-600 to-red-400' : t.act_temp > 50 ? 'bg-gradient-to-t from-orange-500 to-orange-300' : 'bg-gradient-to-t from-green-500 to-green-300'"
                        :style="'height:' + Math.min(100, Math.max(8, (t.act_temp / 80) * 100)) + '%'">
                      </div>
                    </div>
                    <!-- Thermometer bulb -->
                    <div class="w-8 h-8 -mt-1 rounded-full border-2 flex items-center justify-center"
                      :class="t.act_temp > 65 ? 'bg-red-500 border-red-400' : t.act_temp > 50 ? 'bg-orange-500 border-orange-400' : 'bg-green-500 border-green-400'">
                      <div class="w-4 h-4 rounded-full bg-white/30"></div>
                    </div>
                  </div>
                  <!-- Slot label -->
                  <span class="text-xs text-gray-500 mt-2 font-medium" x-text="t.slot"></span>
                  <!-- Danger zone labels -->
                  <span class="text-[10px] mt-0.5"
                    :class="t.act_temp > 65 ? 'text-red-500 font-bold' : t.act_temp > 50 ? 'text-orange-500' : 'text-green-500'"
                    x-text="t.act_temp > 65 ? 'CRITICAL' : t.act_temp > 50 ? 'WARM' : 'NORMAL'"></span>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </template>
  </div>

  <!-- ==================== POWERS TAB ==================== -->
  <div x-show="tab === 'powers' && !loading" x-cloak>
    <!-- Device filter + search -->
    <div class="flex flex-wrap gap-4 mb-4">
      <select x-model="powerDevice" @change="powerPage = 1; fetchReadingsPage(); $nextTick(() => renderPowerChart())"
        class="rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
        <option value="">All Devices</option>
        <template x-for="d in powerDevices" :key="d">
          <option :value="d" x-text="d"></option>
        </template>
      </select>
      <input type="text" x-model.debounce.300ms="powerSearch" @input="powerPage = 1; fetchReadingsPage()"
        placeholder="Search ONT index or description..."
        class="rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm w-56">
    </div>

    <!-- Charts row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Bar chart -->
      <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-5">
        <h3 class="text-sm font-semibold mb-3 text-gray-600 dark:text-gray-400">Weak ONTs per Device</h3>
        <canvas id="powerChart" height="200"></canvas>
      </div>
      <!-- Pie chart (when device selected) -->
      <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-5">
        <h3 class="text-sm font-semibold mb-3 text-gray-600 dark:text-gray-400"
          x-text="powerDevice ? 'ONT Power Distribution: ' + powerDevice : 'Select a device to see ONT breakdown'"></h3>
        <template x-if="!powerDevice">
          <div class="flex items-center justify-center h-48 text-gray-400 text-sm">
            <div class="text-center">
              <svg class="w-12 h-12 mx-auto mb-2 opacity-30" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 107.5 7.5h-7.5V6z"/><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0013.5 3v7.5z"/></svg>
              Select a device from the dropdown
            </div>
          </div>
        </template>
        <template x-if="powerDevice">
          <canvas id="pieChart" height="200"></canvas>
        </template>
      </div>
    </div>

    <!-- Paginated table -->
    <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 overflow-hidden">
      <template x-if="tableLoading">
        <div class="flex items-center justify-center py-10">
          <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
          <span class="ml-2 text-gray-500 text-sm">Loading...</span>
        </div>
      </template>
      <template x-if="!tableLoading">
        <div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="bg-gray-50 dark:bg-gray-800/50">
                  <th class="px-4 py-3 text-left font-semibold text-gray-600 dark:text-gray-400">ONT Index</th>
                  <th class="px-4 py-3 text-left font-semibold text-gray-600 dark:text-gray-400">OLT Rx (dBm)</th>
                  <th class="px-4 py-3 text-left font-semibold text-gray-600 dark:text-gray-400">Desc 1</th>
                  <th class="px-4 py-3 text-left font-semibold text-gray-600 dark:text-gray-400">Desc 2</th>
                  <th class="px-4 py-3 text-left font-semibold text-gray-600 dark:text-gray-400">Device</th>
                  <th class="px-4 py-3 text-left font-semibold text-gray-600 dark:text-gray-400">Site</th>
                  <th class="px-4 py-3 text-left font-semibold text-gray-600 dark:text-gray-400">Host</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
                <template x-for="r in tableRows" :key="r.ID">
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/30">
                    <td class="px-4 py-2.5 font-mono text-xs" x-text="r.ont_idx"></td>
                    <td class="px-4 py-2.5">
                      <span class="font-mono text-xs px-2 py-0.5 rounded-full"
                        :class="r.olt_rx < -24 ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' : r.olt_rx < -22 ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400' : 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'"
                        x-text="r.olt_rx.toFixed(1)"></span>
                    </td>
                    <td class="px-4 py-2.5 text-xs" x-text="r.desc1 || '—'"></td>
                    <td class="px-4 py-2.5 text-xs" x-text="r.desc2 || '—'"></td>
                    <td class="px-4 py-2.5 text-xs" x-text="r.device"></td>
                    <td class="px-4 py-2.5 text-xs" x-text="r.site"></td>
                    <td class="px-4 py-2.5 font-mono text-xs" x-text="r.host"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <!-- Pagination controls -->
          <div class="flex items-center justify-between px-4 py-3 border-t border-gray-200 dark:border-gray-800">
            <span class="text-sm text-gray-500" x-text="tableTotal + ' total ONTs \u00B7 Page ' + powerPage + ' of ' + tableTotalPages"></span>
            <div class="flex gap-2">
              <button @click="powerPage = Math.max(1, powerPage - 1); fetchReadingsPage()" :disabled="powerPage <= 1"
                class="px-3 py-1.5 text-sm rounded-lg border border-gray-300 dark:border-gray-600 disabled:opacity-40 hover:bg-gray-100 dark:hover:bg-gray-800">Prev</button>
              <button @click="powerPage = Math.min(tableTotalPages, powerPage + 1); fetchReadingsPage()" :disabled="powerPage >= tableTotalPages"
                class="px-3 py-1.5 text-sm rounded-lg border border-gray-300 dark:border-gray-600 disabled:opacity-40 hover:bg-gray-100 dark:hover:bg-gray-800">Next</button>
            </div>
          </div>
        </div>
      </template>
    </div>
  </div>

  <!-- ==================== PORT PROTECTION TAB ==================== -->
  <div x-show="tab === 'ports' && !loading" x-cloak>
    <!-- Device filter -->
    <div class="mb-4">
      <select x-model="portDevice"
        class="rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
        <option value="">All Devices</option>
        <template x-for="d in portDevices" :key="d">
          <option :value="d" x-text="d"></option>
        </template>
      </select>
    </div>

    <template x-if="filteredPorts.length === 0 && !loading">
      <p class="text-gray-500 text-center py-10">No down ports detected.</p>
    </template>

    <!-- Legend -->
    <div class="flex flex-wrap gap-4 mb-4 text-xs text-gray-500">
      <div class="flex items-center gap-1.5">
        <span class="w-3 h-3 rounded-full bg-green-500 inline-block"></span> act-up
      </div>
      <div class="flex items-center gap-1.5">
        <span class="w-3 h-3 rounded-full bg-red-500 inline-block"></span> act-down
      </div>
      <div class="flex items-center gap-1.5">
        <span class="w-3 h-3 rounded-full bg-gray-400 inline-block"></span> inact-down
      </div>
      <div class="flex items-center gap-1.5">
        <span class="w-3 h-3 rounded-full bg-yellow-500 inline-block"></span> inact-up
      </div>
    </div>

    <!-- Device groups -->
    <div class="space-y-4">
      <template x-for="group in portGroups" :key="group.device">
        <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-5">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h3 class="font-semibold text-sm" x-text="group.device"></h3>
              <p class="text-xs text-gray-500" x-text="group.host + ' \u00B7 ' + group.site"></p>
            </div>
            <div class="flex gap-2">
              <span class="text-xs px-2 py-1 rounded-full bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400"
                x-text="group.ports.filter(p => p.port_state === 'act-down' || p.paired_state === 'act-down').length + ' act-down'"
                x-show="group.ports.filter(p => p.port_state === 'act-down' || p.paired_state === 'act-down').length > 0"></span>
              <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400"
                x-text="group.ports.filter(p => p.port_state === 'inact-down' || p.paired_state === 'inact-down').length + ' inact-down'"
                x-show="group.ports.filter(p => p.port_state === 'inact-down' || p.paired_state === 'inact-down').length > 0"></span>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            <template x-for="p in group.ports" :key="p.port">
              <div class="flex items-center gap-3 px-4 py-3 rounded-lg border transition-colors"
                :class="portCardClass(p)">
                <!-- Port name -->
                <span class="font-mono text-xs font-semibold min-w-[80px]" x-text="p.port"></span>
                <!-- Port state dot -->
                <div class="flex flex-col items-center gap-0.5">
                  <span class="w-3.5 h-3.5 rounded-full transition-colors"
                    :class="stateColor(p.port_state)"></span>
                  <span class="text-[9px] text-gray-400" x-text="p.port_state"></span>
                </div>
                <!-- Paired state dot (ring style) -->
                <div class="flex flex-col items-center gap-0.5">
                  <span class="w-3.5 h-3.5 rounded-full border-[2.5px] transition-colors"
                    :class="stateBorderColor(p.paired_state)"></span>
                  <span class="text-[9px] text-gray-400" x-text="p.paired_state"></span>
                </div>
                <!-- SWO info -->
                <template x-if="p.swo_reason">
                  <span class="ml-auto text-[10px] text-gray-400 font-mono" x-text="p.swo_reason + ' (' + p.num_swo + ')'"></span>
                </template>
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>
</div>

<script>
function dashboardPage() {
  return {
    tab: 'health',
    loading: true,
    healthData: [],
    healthIdx: 0,
    powerSummary: [],
    downPorts: [],
    powerDevice: '',
    powerSearch: '',
    portDevice: '',
    powerChartInstance: null,
    pieChartInstance: null,
    tableRows: [],
    tableTotal: 0,
    tableTotalPages: 1,
    powerPage: 1,
    tableLoading: false,

    async init() {
      const [hRes, sRes, portRes] = await Promise.all([
        fetch('/api/health'),
        fetch('/api/power/summary'),
        fetch('/api/ports/down')
      ]);
      this.healthData = await hRes.json() || [];
      this.powerSummary = await sRes.json() || [];
      this.downPorts = await portRes.json() || [];
      this.loading = false;

      this.fetchReadingsPage();
    },

    get currentHealth() {
      return this.healthData[this.healthIdx] || {};
    },

    getCpuColor(load) {
      if (load > 80) return 'bg-red-500';
      if (load > 60) return 'bg-yellow-500';
      return 'bg-green-500';
    },

    stateColor(s) {
      if (s === 'act-up') return 'bg-green-500 shadow-sm shadow-green-500/50';
      if (s === 'act-down') return 'bg-red-500 shadow-sm shadow-red-500/50';
      if (s === 'inact-down') return 'bg-gray-400 shadow-sm shadow-gray-400/30';
      if (s === 'inact-up') return 'bg-yellow-500 shadow-sm shadow-yellow-500/50';
      return 'bg-gray-400';
    },
    stateBorderColor(s) {
      if (s === 'act-up') return 'border-green-500 shadow-sm shadow-green-500/50';
      if (s === 'act-down') return 'border-red-500 shadow-sm shadow-red-500/50';
      if (s === 'inact-down') return 'border-gray-400 shadow-sm shadow-gray-400/30';
      if (s === 'inact-up') return 'border-yellow-500 shadow-sm shadow-yellow-500/50';
      return 'border-gray-400';
    },
    portCardClass(p) {
      if (p.port_state === 'act-down' || p.paired_state === 'act-down')
        return 'border-red-200 dark:border-red-900/50 bg-red-50/50 dark:bg-red-900/10';
      if (p.port_state === 'inact-down' || p.paired_state === 'inact-down')
        return 'border-gray-300 dark:border-gray-700 bg-gray-100/50 dark:bg-gray-800/30';
      if (p.port_state === 'inact-up' || p.paired_state === 'inact-up')
        return 'border-yellow-200 dark:border-yellow-900/50 bg-yellow-50/50 dark:bg-yellow-900/10';
      return 'border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50';
    },

    // Powers
    get powerDevices() {
      return [...new Set(this.powerSummary.map(s => s.device))].sort();
    },

    async fetchReadingsPage() {
      this.tableLoading = true;
      const params = new URLSearchParams({ page: this.powerPage, per_page: 50 });
      if (this.powerDevice) params.set('device', this.powerDevice);
      if (this.powerSearch) params.set('search', this.powerSearch);
      try {
        const res = await fetch('/api/power/readings?' + params);
        const json = await res.json();
        this.tableRows = json.data || [];
        this.tableTotal = json.total || 0;
        this.tableTotalPages = json.total_pages || 1;
        this.powerPage = json.page || 1;
      } catch (e) {
        this.tableRows = [];
      }
      this.tableLoading = false;
    },

    renderPowerChart() {
      const canvas = document.getElementById('powerChart');
      if (!canvas) return;
      if (this.powerChartInstance) this.powerChartInstance.destroy();

      const labels = this.powerSummary.filter(s => s.weak_count > 0).map(s => s.device);
      const data = this.powerSummary.filter(s => s.weak_count > 0).map(s => s.weak_count);

      const isDark = document.documentElement.classList.contains('dark');
      this.powerChartInstance = new Chart(canvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Weak ONTs',
            data: data,
            backgroundColor: 'rgba(239, 68, 68, 0.7)',
            borderColor: 'rgba(239, 68, 68, 1)',
            borderWidth: 1,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Weak Power ONTs per Device', color: isDark ? '#ccc' : '#333' }
          },
          scales: {
            y: { beginAtZero: true, ticks: { color: isDark ? '#aaa' : '#555', stepSize: 1 }, grid: { color: isDark ? '#333' : '#eee' } },
            x: {
              ticks: { color: isDark ? '#aaa' : '#555', maxRotation: 90, font: { size: 10 },
                callback: function(value, index) {
                  const label = this.getLabelForValue(index);
                  return label.length > 15 ? label.substring(0, 15) + '...' : label;
                }
              },
              grid: { display: false }
            }
          }
        }
      });

      this.renderPieChart();
    },

    renderPieChart() {
      if (this.pieChartInstance) { this.pieChartInstance.destroy(); this.pieChartInstance = null; }
      if (!this.powerDevice) return;

      const pieCanvas = document.getElementById('pieChart');
      if (!pieCanvas) return;

      const s = this.powerSummary.find(s => s.device === this.powerDevice);
      if (!s) return;
      const weakCount = s.weak_count;
      const normalCount = s.total - weakCount;

      const isDark = document.documentElement.classList.contains('dark');
      this.pieChartInstance = new Chart(pieCanvas, {
        type: 'pie',
        data: {
          labels: ['Normal Power (' + normalCount + ')', 'Weak Power (' + weakCount + ')'],
          datasets: [{
            data: [normalCount, weakCount],
            backgroundColor: ['rgba(34, 197, 94, 0.7)', 'rgba(239, 68, 68, 0.7)'],
            borderColor: [isDark ? '#1f2937' : '#ffffff', isDark ? '#1f2937' : '#ffffff'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom', labels: { color: isDark ? '#ccc' : '#333', padding: 16 } },
            title: { display: true, text: s.total + ' total ONTs', color: isDark ? '#999' : '#666', font: { size: 12, weight: 'normal' } }
          }
        }
      });
    },

    // Ports
    get portDevices() {
      return [...new Set(this.downPorts.map(p => p.device))].sort();
    },
    get filteredPorts() {
      if (!this.portDevice) return this.downPorts;
      return this.downPorts.filter(p => p.device === this.portDevice);
    },
    get portGroups() {
      const map = {};
      this.filteredPorts.forEach(p => {
        const key = p.device + '|' + p.host;
        if (!map[key]) map[key] = { device: p.device, host: p.host, site: p.site, ports: [] };
        map[key].ports.push(p);
      });
      return Object.values(map);
    }
  }
}
</script>
{{end}}
