{{define "content"}}
<div x-data="backupsPage()" x-init="init()">
  <h1 class="text-2xl font-bold mb-6">Backups</h1>

  <!-- Loading -->
  <template x-if="loading">
    <div class="flex items-center justify-center py-20">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
      <span class="ml-3 text-gray-500">Loading backups...</span>
    </div>
  </template>

  <template x-if="!loading">
    <div>
      <template x-if="backups.length === 0">
        <p class="text-gray-500 text-center py-10">No backups available.</p>
      </template>

      <template x-if="backups.length > 0">
        <div>
          <!-- Breadcrumb -->
          <div class="flex items-center gap-2 mb-4 text-sm">
            <button @click="currentSite = ''; currentDate = ''"
              class="flex items-center gap-1.5 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
              :class="!currentSite ? 'text-gray-900 dark:text-gray-100 font-semibold' : 'text-blue-600 dark:text-blue-400'">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"/></svg>
              Backups
            </button>
            <template x-if="currentSite">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"/></svg>
                <button @click="currentDate = ''"
                  class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                  :class="!currentDate ? 'text-gray-900 dark:text-gray-100 font-semibold' : 'text-blue-600 dark:text-blue-400'"
                  x-text="currentSite">
                </button>
              </div>
            </template>
            <template x-if="currentDate">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"/></svg>
                <span class="text-gray-900 dark:text-gray-100 font-semibold" x-text="currentDate"></span>
              </div>
            </template>
          </div>

          <!-- Site folders (root level) -->
          <div x-show="!currentSite">
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
              <template x-for="site in sites" :key="site.name">
                <button @click="currentSite = site.name"
                  class="group flex flex-col items-center gap-2 p-5 rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all">
                  <svg class="w-14 h-14 text-yellow-500 group-hover:text-yellow-400 transition-colors" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/>
                  </svg>
                  <span class="text-sm font-medium text-center truncate w-full" x-text="site.name"></span>
                  <span class="text-[10px] text-gray-400" x-text="site.count + ' files'"></span>
                </button>
              </template>
            </div>
          </div>

          <!-- Date folders (inside a site) -->
          <div x-show="currentSite && !currentDate">
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
              <template x-for="d in datesForSite" :key="d.date">
                <button @click="currentDate = d.date"
                  class="group flex flex-col items-center gap-2 p-5 rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all">
                  <svg class="w-14 h-14 text-blue-400 group-hover:text-blue-300 transition-colors" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/>
                  </svg>
                  <span class="text-sm font-medium" x-text="d.date"></span>
                  <span class="text-[10px] text-gray-400" x-text="d.count + ' files'"></span>
                </button>
              </template>
            </div>
          </div>

          <!-- Files (inside a date folder) -->
          <div x-show="currentSite && currentDate">
            <div class="space-y-2">
              <template x-for="b in filesForDate" :key="b.ID">
                <div class="flex items-center gap-4 px-4 py-3 bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 hover:border-blue-300 dark:hover:border-blue-700 transition-colors">
                  <svg class="w-8 h-8 flex-shrink-0 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
                  </svg>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium truncate" x-text="b.device"></p>
                    <p class="text-xs text-gray-500 font-mono truncate" x-text="b.host"></p>
                  </div>
                  <div class="text-right text-xs text-gray-400 flex-shrink-0">
                    <p x-text="new Date(b.CreatedAt).toLocaleTimeString()"></p>
                  </div>
                  <a :href="'/api/backups/' + b.ID + '/download'"
                    class="flex-shrink-0 inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 dark:bg-blue-900/20 dark:text-blue-400 dark:hover:bg-blue-900/30 transition-colors">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
                    Download
                  </a>
                </div>
              </template>
            </div>
          </div>

          <!-- Summary bar -->
          <div class="mt-6 text-sm text-gray-500 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"/></svg>
            <span x-text="backups.length + ' total backup files across ' + sites.length + ' sites'"></span>
          </div>
        </div>
      </template>
    </div>
  </template>
</div>

<script>
function backupsPage() {
  return {
    backups: [],
    loading: true,
    currentSite: '',
    currentDate: '',

    async init() {
      const res = await fetch('/api/backups');
      this.backups = await res.json() || [];
      this.loading = false;
    },

    get sites() {
      const map = {};
      this.backups.forEach(b => {
        if (!map[b.site]) map[b.site] = 0;
        map[b.site]++;
      });
      return Object.entries(map).sort((a, b) => a[0].localeCompare(b[0])).map(([name, count]) => ({ name, count }));
    },

    get datesForSite() {
      const map = {};
      this.backups.filter(b => b.site === this.currentSite).forEach(b => {
        const date = new Date(b.CreatedAt).toISOString().split('T')[0];
        if (!map[date]) map[date] = 0;
        map[date]++;
      });
      return Object.entries(map).sort((a, b) => b[0].localeCompare(a[0])).map(([date, count]) => ({ date, count }));
    },

    get filesForDate() {
      return this.backups.filter(b => {
        if (b.site !== this.currentSite) return false;
        const date = new Date(b.CreatedAt).toISOString().split('T')[0];
        return date === this.currentDate;
      });
    }
  }
}
</script>
{{end}}
