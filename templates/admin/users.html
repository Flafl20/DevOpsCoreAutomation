{{define "content"}}
<div x-data="adminUsersPage()" x-init="init()">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold">Admin Panel â€” Users</h1>
    <button @click="openCreate()" class="px-4 py-2 text-sm font-medium rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors">
      + Add User
    </button>
  </div>

  <!-- Search -->
  <div class="mb-4">
    <input type="text" x-model="search" @input.debounce.300ms="fetchUsers()" placeholder="Search by name..." class="w-72 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
  </div>

  <!-- Loading -->
  <template x-if="loading">
    <div class="flex items-center justify-center py-20">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
      <span class="ml-3 text-gray-500">Loading users...</span>
    </div>
  </template>

  <!-- Users table -->
  <template x-if="!loading">
    <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-gray-50 dark:bg-gray-800/50">
              <th class="px-4 py-3 text-left font-semibold text-gray-600 dark:text-gray-400">ID</th>
              <th class="px-4 py-3 text-left font-semibold text-gray-600 dark:text-gray-400">Full Name</th>
              <th class="px-4 py-3 text-left font-semibold text-gray-600 dark:text-gray-400">Email</th>
              <th class="px-4 py-3 text-left font-semibold text-gray-600 dark:text-gray-400">Role</th>
              <th class="px-4 py-3 text-left font-semibold text-gray-600 dark:text-gray-400">Status</th>
              <th class="px-4 py-3 text-right font-semibold text-gray-600 dark:text-gray-400">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
            <template x-for="u in users" :key="u.ID">
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/30 transition-colors">
                <td class="px-4 py-2.5 text-xs text-gray-500" x-text="u.ID"></td>
                <td class="px-4 py-2.5 font-medium" x-text="u.fullname"></td>
                <td class="px-4 py-2.5 text-xs" x-text="u.email"></td>
                <td class="px-4 py-2.5">
                  <span class="px-2 py-0.5 text-xs rounded-full"
                    :class="u.role === 'admin' ? 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400' : 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300'"
                    x-text="u.role"></span>
                </td>
                <td class="px-4 py-2.5">
                  <span class="px-2 py-0.5 text-xs rounded-full"
                    :class="u.active ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'"
                    x-text="u.active ? 'Active' : 'Inactive'"></span>
                </td>
                <td class="px-4 py-2.5 text-right">
                  <button @click="openEdit(u)" class="px-2 py-1 text-xs rounded-lg text-blue-600 hover:bg-blue-50 dark:text-blue-400 dark:hover:bg-blue-900/20">Edit</button>
                  <button @click="confirmDelete(u)" class="px-2 py-1 text-xs rounded-lg text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20">Delete</button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="flex items-center justify-between px-4 py-3 border-t border-gray-200 dark:border-gray-800">
        <span class="text-sm text-gray-500" x-text="'Page ' + page + ' of ' + totalPages + ' (' + total + ' users)'"></span>
        <div class="flex gap-2">
          <button @click="page--; fetchUsers()" :disabled="page <= 1" class="px-3 py-1 text-sm rounded-lg border border-gray-300 dark:border-gray-600 disabled:opacity-40 hover:bg-gray-100 dark:hover:bg-gray-800">Prev</button>
          <button @click="page++; fetchUsers()" :disabled="page >= totalPages" class="px-3 py-1 text-sm rounded-lg border border-gray-300 dark:border-gray-600 disabled:opacity-40 hover:bg-gray-100 dark:hover:bg-gray-800">Next</button>
        </div>
      </div>
    </div>
  </template>

  <!-- Create / Edit Modal -->
  <div x-show="showModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="fixed inset-0 bg-black/50" @click="showModal = false"></div>
    <div class="relative bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 w-full max-w-md mx-4 p-6 shadow-xl">
      <h2 class="text-lg font-semibold mb-4" x-text="editingUser ? 'Edit User' : 'Create User'"></h2>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Full Name</label>
          <input type="text" x-model="form.full_name" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Email</label>
          <input type="email" x-model="form.email" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
        </div>
        <template x-if="!editingUser">
          <div>
            <label class="block text-sm font-medium mb-1">Password</label>
            <input type="password" x-model="form.password" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
          </div>
        </template>
        <div>
          <label class="block text-sm font-medium mb-1">Role</label>
          <select x-model="form.role" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <template x-if="editingUser">
          <div class="flex items-center gap-2">
            <input type="checkbox" x-model="form.active" id="activeToggle" class="rounded border-gray-300">
            <label for="activeToggle" class="text-sm">Active</label>
          </div>
        </template>
      </div>

      <template x-if="formError">
        <p class="mt-3 text-sm text-red-600 dark:text-red-400" x-text="formError"></p>
      </template>

      <div class="flex justify-end gap-3 mt-6">
        <button @click="showModal = false" class="px-4 py-2 text-sm rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-800">Cancel</button>
        <button @click="submitForm()" :disabled="submitting" class="px-4 py-2 text-sm font-medium rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50">
          <span x-text="submitting ? 'Saving...' : (editingUser ? 'Update' : 'Create')"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- Delete confirmation -->
  <div x-show="showDeleteModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="fixed inset-0 bg-black/50" @click="showDeleteModal = false"></div>
    <div class="relative bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 w-full max-w-sm mx-4 p-6 shadow-xl">
      <h2 class="text-lg font-semibold mb-2">Delete User</h2>
      <p class="text-sm text-gray-500 mb-6">Are you sure you want to delete <strong x-text="deletingUser?.fullname"></strong>? This cannot be undone.</p>
      <div class="flex justify-end gap-3">
        <button @click="showDeleteModal = false" class="px-4 py-2 text-sm rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-800">Cancel</button>
        <button @click="deleteUser()" class="px-4 py-2 text-sm font-medium rounded-lg bg-red-600 text-white hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>
</div>

<script>
function adminUsersPage() {
  return {
    users: [],
    loading: true,
    page: 1,
    limit: 20,
    total: 0,
    totalPages: 1,
    search: '',
    showModal: false,
    showDeleteModal: false,
    editingUser: null,
    deletingUser: null,
    submitting: false,
    formError: '',
    form: { full_name: '', email: '', password: '', role: 'user', active: true },

    async init() {
      await this.fetchUsers();
    },

    async fetchUsers() {
      this.loading = true;
      let url = '/api/admin/users?page=' + this.page + '&limit=' + this.limit;
      if (this.search) url += '&search=' + encodeURIComponent(this.search);
      const res = await fetch(url);
      const data = await res.json();
      this.users = data.users || [];
      this.total = data.pagination?.total || 0;
      this.totalPages = data.pagination?.total_pages || 1;
      this.loading = false;
    },

    openCreate() {
      this.editingUser = null;
      this.form = { full_name: '', email: '', password: '', role: 'user', active: true };
      this.formError = '';
      this.showModal = true;
    },

    openEdit(user) {
      this.editingUser = user;
      this.form = { full_name: user.fullname, email: user.email, role: user.role, active: user.active };
      this.formError = '';
      this.showModal = true;
    },

    async submitForm() {
      this.submitting = true;
      this.formError = '';
      try {
        let res;
        if (this.editingUser) {
          res = await fetch('/api/admin/users/' + this.editingUser.ID, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(this.form)
          });
        } else {
          res = await fetch('/api/admin/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(this.form)
          });
        }
        const data = await res.json();
        if (!res.ok) {
          this.formError = data.error || data.details || 'Failed';
        } else {
          this.showModal = false;
          await this.fetchUsers();
        }
      } catch (e) {
        this.formError = 'Network error';
      }
      this.submitting = false;
    },

    confirmDelete(user) {
      this.deletingUser = user;
      this.showDeleteModal = true;
    },

    async deleteUser() {
      const res = await fetch('/api/admin/users/' + this.deletingUser.ID, { method: 'DELETE' });
      this.showDeleteModal = false;
      this.deletingUser = null;
      await this.fetchUsers();
    }
  }
}
</script>
{{end}}
